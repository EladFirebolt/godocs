name: Production Build and Deploy
on:
  push:
    branches: 
      - gh-pages
      - rvs-test

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:

      - name: Setup Node.js
        uses: actions/setup-node@v2

      # https://github.com/actions/checkout#push-a-commit-using-the-built-in-token
      - name: Set GitHub Actions as Commit Author
        run: |
          git config --global user.name github-actions
          git config --global user.email github-actions@github.com

      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: 'build'
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref_name }}

      - name: Generate app token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.GH_APP_CI_GITOPS_APP_ID }}
          private_key: ${{ secrets.GH_APP_CI_GITOPS_KEY_PEM }}

      - name: Checkout Guru Synch Target
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}
          repository: firebolt-analytics/firebolt-doc-to-guru
          path: 'deploysync'
          ref: 'main'

      - name: Checkout Preview Target
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}
          repository: firebolt-analytics/firebolt-docs-preview-cntrbtr
          path: 'preview'
          ref: 'gh_pages'

      - name: Build
        run: |
          cp -r build/* deploysync
          cp -r build/* preview
          for dir in build deploysync preview; 
            do 
              cd $dir
              git checkout $GITHUB_REF_NAME || git checkout -b $GITHUB_REF_NAME 
              git add -A 
              git commit -m "feat(no_issue): update with $GITHUB_SHA"
              git push origin $GITHUB_REF_NAME
            done
              
      # git checkout $TARGET_BRANCH
      # git pull https://github.com/firebolt-analytics/firebolt-docs-staging.git $TARGET_BRANCH
      # git push origin $TARGET_BRANCH

      # - name: Checkout Staging Target
      #   uses: actions/checkout@v4
      #   with:
      #     path: 'deploy'
      #     token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Push files to target
      #   run: |
      #     cp -r build/* deploy
      #     cd deploy
      #     git add -A
      #     git commit -m $GITHUB_SHA
      #     git push

      

      # - name: Push files to target
      #   run: |
      #     cp -r build/* deploysync
      #     cd deploysync
      #     git add -A
      #     git commit -m $GITHUB_SHA
      #     git push

      

      # - name: Push files to target
      #   run: |
      #     cp -r build/* preview
      #     cd preview
      #     git add -A
      #     git commit -m $GITHUB_SHA
      #     git push
